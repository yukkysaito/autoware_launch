<launch>

  <!-- common parameters -->
  <arg name="lateral_controller_mode" default="mpc_follower" description="options: mpc_follower, pure_pursuit"/>

  <!-- control parameter -->
  <arg name="mpc_follower_param_path" default="$(find-pkg-share control_launch)/config/mpc_follower/mpc_follower.param.yaml"/>
  <arg name="pure_pursuit_param_path" default="$(find-pkg-share control_launch)/config/pure_pursuit/pure_pursuit.param.yaml"/>
  <arg name="velocity_controller_param_path" default="$(find-pkg-share control_launch)/config/velocity_controller/velocity_controller.param.yaml"/>
  <arg name="vehicle_cmd_gate_param_path" default="$(find-pkg-share control_launch)/config/vehicle_cmd_gate/vehicle_cmd_gate.param.yaml"/>

  <!-- control module -->
  <group>
    <push-ros-namespace namespace="control"/>

    <!-- trajectory follower -->
    <group>
      <push-ros-namespace namespace="trajectory_follower"/>

      <!-- lateral controller -->
      <group if="$(eval &quot;'$(var lateral_controller_mode)'=='mpc_follower'&quot;)">
        <include file="$(find-pkg-share mpc_follower)/launch/mpc_follower.launch.xml">
          <arg name="mpc_follower_param_path" value="$(var mpc_follower_param_path)" />
        </include>
      </group>

      <group if="$(eval &quot;'$(var lateral_controller_mode)'=='pure_pursuit'&quot;)">
        <include file="$(find-pkg-share pure_pursuit)/launch/pure_pursuit.launch.xml">
          <arg name="pure_pursuit_param_path" value="$(var pure_pursuit_param_path)" />
        </include>
      </group>

      <!-- longitudinal controller -->
      <include file="$(find-pkg-share velocity_controller)/launch/velocity_controller.launch.xml">
        <arg name="velocity_controller_param_path" value="$(var velocity_controller_param_path)"/>
        <arg name="enable_smooth_stop" value="false" />
      </include>

      <!-- latlon coupler -->
      <node pkg="latlon_muxer" exec="latlon_muxer" name="latlon_muxer" output="screen">
        <remap from="input/lateral/control_cmd" to="lateral/control_cmd"/>
        <remap from="input/longitudinal/control_cmd" to="longitudinal/control_cmd"/>
        <remap from="output/control_cmd" to="control_cmd"/>
      </node>

      <!-- lane departure checker -->
      <include file="$(find-pkg-share lane_departure_checker)/launch/lane_departure_checker.launch.xml">
      </include>
    </group>

    <!-- shift decider -->
    <include file="$(find-pkg-share shift_decider)/launch/shift_decider.launch.xml">
    </include>

    <!-- vehicle cmd gate -->
    <include file="$(find-pkg-share vehicle_cmd_gate)/launch/vehicle_cmd_gate.launch.xml">
      <arg name="config_file" value="$(var vehicle_cmd_gate_param_path)"/>
      <arg name="use_emergency_handling" value="true"/>
      <arg name="use_external_emergency_stop" value="true"/>
    </include>

    <!-- For backward compatibility of external commands -->
    <group>
      <node pkg="topic_tools" exec="relay" name="relay_remote_remote_control_cmd">
        <param name="input_topic" value="/remote/external_control_cmd" />
        <param name="output_topic" value="/external/remote/external_control_cmd" />
        <param name="type" value="autoware_vehicle_msgs/msg/RawControlCommandStamped" />
      </node>
      <node pkg="topic_tools" exec="relay" name="relay_remote_shift_cmd">
        <param name="input_topic" value="/remote/shift_cmd" />
        <param name="output_topic" value="/external/remote/shift_cmd" />
        <param name="type" value="autoware_vehicle_msgs/msg/ShiftStamped" />
      </node>
      <node pkg="topic_tools" exec="relay" name="relay_remote_turn_signal_cmd">
        <param name="input_topic" value="/remote/turn_signal_cmd" />
        <param name="output_topic" value="/external/remote/turn_signal_cmd" />
        <param name="type" value="autoware_vehicle_msgs/msg/TurnSignal" />
      </node>
    </group>

    <!-- external_cmd_selector -->
    <include file="$(find-pkg-share external_cmd_selector)/launch/external_cmd_selector.launch.xml">
      <arg name="initial_selector_mode" value="1" />

      <arg name="input/local/control_cmd" value="/external/local/control_cmd" />
      <arg name="input/local/shift_cmd" value="/external/local/shift_cmd" />
      <arg name="input/local/turn_signal_cmd" value="/external/local/turn_signal_cmd" />

      <arg name="input/remote/control_cmd" value="/external/remote/control_cmd" />
      <arg name="input/remote/shift_cmd" value="/external/remote/shift_cmd" />
      <arg name="input/remote/turn_signal_cmd" value="/external/remote/turn_signal_cmd" />
    </include>

    <!-- remote_cmd_converter -->
    <include file="$(find-pkg-share remote_cmd_converter)/launch/remote_cmd_converter.launch.xml">
      <arg name="in/external_control_cmd" value="/external/external_cmd_selector/external_control_cmd" />
      <arg name="in/shift_cmd" value="/external/external_cmd_selector/shift_cmd" />
      <arg name="out/control_cmd" value="/external/external_cmd_selector/control_cmd" />
    </include>
  </group>
</launch>
